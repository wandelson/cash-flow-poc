@page "/fluxo-caixa"

@using Core.Application.Commands
@using Core.Domain.Enums
@using System.Net
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms

@inject IHttpClientFactory HttpFactory

<h3>Fluxo de Caixa Diário</h3>

<div class="mb-3">
    <label>Data:</label>
    <InputDate @bind-Value="_model.Data"
               class="form-control"
               style="max-width: 200px;" />
</div>

<hr />

<h4>Novo lançamento</h4>

<EditForm EditContext="_editContext" OnSubmit="RegistrarLancamento">

    <div class="row mb-3">
        <div class="col-4">
            <InputText class="form-control"
                       placeholder="Descrição"
                       @bind-Value="_model.Descricao" />
            <ValidationMessage For="() => _model.Descricao" />
        </div>

        <div class="col-2">
            <div class="input-group">
                <span class="input-group-text">R$</span>

                <InputNumber class="form-control"
                             step="0.01"
                             @bind-Value="_model.Valor" />
            </div>

            <ValidationMessage For="() => _model.Valor" />
        </div>

        <div class="col-2">
            <InputSelect class="form-select"
                         @bind-Value="_model.Tipo">
                <option value="@TipoLancamento.Credito">Crédito</option>
                <option value="@TipoLancamento.Debito">Débito</option>
            </InputSelect>
        </div>

        <div class="col-2">
            <button type="submit"
                    class="btn btn-success"
                    disabled="@_isSavingLancamento">

                @if (_isSavingLancamento)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    <span>Salvando...</span>
                }
                else
                {
                    <span>Registrar</span>
                }
            </button>
        </div>
    </div>
</EditForm>

<hr />

<button class="btn btn-primary mb-3"
        @onclick="CarregarRelatorio"
        disabled="@_isLoadingRelatorio">

    @if (_isLoadingRelatorio)
    {
        <span class="spinner-border spinner-border-sm me-2"></span>
        <span>Carregando...</span>
    }
    else
    {
        <span>Carregar relatório</span>
    }
</button>

@if (_isLoadingRelatorio)
{
    <div class="alert alert-info text-center">
        <span class="spinner-border spinner-border-sm me-2"></span>
        Carregando relatório...
    </div>
}
else if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-warning text-center">
        @_errorMessage
    </div>
}
else if (relatorio is null)
{
    <div class="alert alert-secondary text-center">
        Nenhum relatório carregado
    </div>
}
else
{
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                Relatório do dia @relatorio.Dia
            </h5>

            <span class="badge @(relatorio.Saldo >= 0 ? "bg-success" : "bg-danger")">
                Saldo: @relatorio.Saldo.ToString("C")
            </span>
        </div>
    </div>
}

@code {

    private RegistrarLancamentoCommand _model = new();
    private EditContext _editContext = default!;
    private ValidationMessageStore _messageStore = default!;

    private RelatorioDiaDto? relatorio;
    private string? _errorMessage;

    private bool _isLoadingRelatorio;
    private bool _isSavingLancamento;

    protected override void OnInitialized()
    {
        CriarEditContext();
    }

    private void CriarEditContext()
    {
        _model = new RegistrarLancamentoCommand
        {
            Data = DateOnly.FromDateTime(DateTime.Today),
            Tipo = TipoLancamento.Credito
        };

        _editContext = new EditContext(_model);
        _messageStore = new ValidationMessageStore(_editContext);

        _editContext.OnValidationRequested += (_, __) =>
            _messageStore.Clear();

        _editContext.OnFieldChanged += (_, __) =>
            _messageStore.Clear();
    }

    private async Task RegistrarLancamento()
    {
        if (_isSavingLancamento)
            return;

        _isSavingLancamento = true;
        _messageStore.Clear();

        try
        {
            var apiLanc = HttpFactory.CreateClient("LancamentosApi");
            var response = await apiLanc.PostAsJsonAsync("/api/lancamentos", _model);

            if (response.StatusCode == HttpStatusCode.BadRequest)
            {
                var error =
                    await response.Content.ReadFromJsonAsync<ValidationErrorResponse>();

                foreach (var entry in error!.Errors)
                {
                    _messageStore.Add(
                        new FieldIdentifier(_model, entry.Key),
                        entry.Value);
                }

                _editContext.NotifyValidationStateChanged();
                return;
            }

            await CarregarRelatorio();
            CriarEditContext();
        }
        finally
        {
            _isSavingLancamento = false;
        }
    }

    private async Task CarregarRelatorio()
    {
        if (_isLoadingRelatorio)
            return;

        _isLoadingRelatorio = true;
        _errorMessage = null;
        relatorio = null;

        try
        {
            var apiRel = HttpFactory.CreateClient("RelatoriosApi");
            var dia = _model.Data.ToString("yyyy-MM-dd");

            var response = await apiRel.GetAsync($"/api/relatorios/{dia}");

            if (response.StatusCode == HttpStatusCode.NoContent)
            {
                _errorMessage = "Não foi encontrado um relatório para a data informada.";
                return;
            }

            if (!response.IsSuccessStatusCode)
            {
                _errorMessage = "Ocorreu um erro inesperado ao gerar o relatório.";
                return;
            }

            relatorio = await response.Content
                .ReadFromJsonAsync<RelatorioDiaDto>();
        }
        finally
        {
            _isLoadingRelatorio = false;
        }
    }

    public class ValidationErrorResponse
    {
        public Dictionary<string, string[]> Errors { get; set; } = new();
    }

    public class RelatorioDiaDto
    {
        public DateOnly Dia { get; set; }
        public decimal Saldo { get; set; }
    }
}
